<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>React Tutorial</title>
    <!-- Not present in the tutorial. Just for basic styling. -->
    <link rel="stylesheet" href="css/base.css" />
    <script src="scripts/react.js"></script>
    <script src="scripts/react-dom.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <script src="scripts/babel.min.js"></script>
  </head>
  <body>
    <div id="content"></div>
    <script type="text/babel">

    var apiUrl = "http://192.168.33.10/api/";
    var fields;

    var NameBox = React.createClass({
      render: function() {
        var value = this.props.rowName ? this.props.rowName : '';
        return (
          <div className="nameBox">
            <input type='text'
              placeholder='Name'
              onInput={this.props.handleNameChange.bind(null, this.props.rowId)}
              value={value}
            />
          </div>
        );
      }
    });

    var AddFieldBox = React.createClass({
      render: function() {
        return (
          <div className="addFieldBox">
            <button onClick={this.props.handleAddRow}>Add</button>
          </div>
        );
      }
    });

    var RemoveRowBox = React.createClass({
      render: function() {
        return (
          <div className="RemoveRowBox">
            <button onClick={this.props.handleRemoveRow.bind(null, this.props.rowId)}>Remove</button>
          </div>
        );
      }
    });

    var FieldSubTypeBox = React.createClass({

      getInitialState: function() {
        return {
          fields: []
        }
      },

      render: function() {
        if (this.props.availableFields.length > 0 && this.props.fieldSelected !== undefined && this.props.availableFields[this.props.fieldSelected].options) {
          var subTypes = this.props.availableFields[this.props.fieldSelected].options.options;

          return (
            <div className='fieldSubTypeBox'>
              <label>
                {this.props.availableFields[this.props.fieldSelected].options.name}
              </label>
              <select onChange={this.props.handleSubFieldSelection.bind(null, this.props.rowId)}>
                {
                  Object.keys(subTypes).map(function (key) {
                    var label = subTypes[key]
                    return (
                      <option key={key} value={key}>
                        {label}
                      </option>
                    )
                  })
                }
              </select>
            </div>
          );
        } else {
          return (<div></div>);
        }
      }
    });

    var FieldTypeBox = React.createClass({

      render: function() {
        return (
          <div className='fieldTypeBox'>
            <select onChange={this.props.handleFieldSelection.bind(null, this.props.rowId)}>
              {this.props.availableFields.map(function(field, i) {
                return (
                  <option key={i} name={field.name} value={i}/*value={field.id}*/>
                    {field.label}
                  </option>
                )
              })}
            </select>
          </div>
        );
      }
    });

    var RowBox = React.createClass({

      render: function() {
        var removeBox = '';
        var addBox = '';

        if (this.props.nbRows > 1) {
          removeBox = <RemoveRowBox rowId={this.props.value.id} handleRemoveRow={this.props.handleRemoveRow}/>;
        }

        if (this.props.lastRow) {
          addBox = <AddFieldBox handleAddRow={this.props.handleAddRow}/>;
        }

        return (
          <div className='rowBox'>
            <NameBox
              handleNameChange={this.props.handleNameChange}
              rowId={this.props.value.id}
              rowName={this.props.value.name}
            />
            <FieldTypeBox
              availableFields={this.props.availableFields}
              handleFieldSelection={this.props.handleFieldSelection}
              rowId={this.props.value.id}
            />
            <FieldSubTypeBox
              availableFields={this.props.availableFields}
              fieldSelected={this.props.value.fieldId}
              handleSubFieldSelection={this.props.handleSubFieldSelection}
              rowId={this.props.value.id}
            />
            {addBox}
            {removeBox}
          </div>
        );
      }
    });

    var ResultBox = React.createClass({
      /*
      var outputTypes = {
        'csv' => 'CSV',
        'json' => 'JSON',
        'html' => 'HTML',
        'sql' => 'SQL',
      };
      */
      getInitialState: function (){
        return {
          type: 'html'
        }
      },
      render: function() {

        var returnBox = <div></div>;
        if (!this.props.result) {
          return returnBox;
        }

        if (this.state.type === 'html') {
          returnBox = <div>{JSON.stringify(this.props.result)}</div>;
        }

        return returnBox;


        return (
          <div className='resultBox'>

          </div>
        )
      }
    })

    var FormBox = React.createClass({
      getInitialState: function() {
        return {
          rows: [{id: 0}], // TODO change to load for a previous source such as local data or session
          availableFields : [],
          records: 10
        }
      },

      componentDidMount: function(){
        this.serverRequest = $.get(apiUrl+'fields', function (result) {
          this.setState({
            availableFields: result
          });

          // Trigger change event after init
          var event = new Event('change', { bubbles: true });
          $('select')[0].dispatchEvent(event); // For field select
          $('select')[1].dispatchEvent(event); // For subfield select
        }.bind(this))
      },

      handleAddRow: function(e) {
        e.preventDefault();

        var rows = this.state.rows;

        // Get last id
        var maxId = Number(rows.slice(-1)[0].id);
        maxId++;

        rows.push({id: maxId});

        this.setState({
          rows: rows
        })
      },

      handleRemoveRow: function(rowId, e) {
        e.preventDefault();

        var rows = this.state.rows;

        for (var i in rows) {
          if (rows[i].id == rowId) {
            rows.splice(i, 1);
          }
        }

        this.setState({
          rows: rows
        });
      },

      handleNameChange: function(rowId, e) {
        var rows = this.state.rows;

        for (var i in rows) {
          if (rows[i].id == rowId) {
            rows[i].name = e.target.value;
            break;
          }
        }

        this.setState({
          rows: rows
        });
      },

      handleFieldSelection: function(rowId, e) {
        var rows = this.state.rows;
        var selectedName = $(e.target.options[e.target.selectedIndex]).attr('name');

        if (selectedName) {
          for (var i in rows) {
            if (rows[i].id == rowId) {
              rows[i].type = selectedName;
              rows[i].fieldId = e.target.value;
              break;
            }
          }
        }

        this.setState({
          rows: rows
        });
      },

      handleSubFieldSelection: function(rowId, e) {
        var rows = this.state.rows;
        var selectedName = $(e.target.options[e.target.selectedIndex]).val();

        if (selectedName) {
          for (var i in rows) {
            if (rows[i].id == rowId) {
              rows[i].subtype = selectedName;
              break;
            }
          }
        }

        this.setState({
          rows: rows
        });
      },

      handleFormSubmission: function(e) {
        var data = JSON.stringify({
          queryFields : this.state.rows,
          records: this.state.records
        });

        var fd = new FormData();
        fd.append('query', data);

        var p = $.ajax({
          url: apiUrl+'generate',
          data: fd,
          processData: false,
          contentType: false,
          type: 'POST'
        });

        p.done(function(result) {
          this.setState({
            result: result
          });
        }.bind(this));

        p.fail(function(result) {
          var message = "Server error, please try again later."
          if (result.responseJSON.message) {
            message = result.responseJSON.message;
          }

          alert(message);
        });
      },

      handleNumberSelection: function(e) {
        this.setState({
          records: $(e.target).val()
        });
      },

      render: function() {
        return (
          <div className='formBox'>
            <form>
            {this.state.rows.map(function(row, i) {
              var lastRow = false;
              if (this.state.rows.length === i + 1) {
                lastRow = true;
              }

              return (
                <RowBox key={i}
                        value={row}
                        availableFields={this.state.availableFields}
                        handleAddRow={this.handleAddRow}
                        handleRemoveRow={this.handleRemoveRow}
                        handleNameChange={this.handleNameChange}
                        handleFieldSelection={this.handleFieldSelection}
                        handleSubFieldSelection={this.handleSubFieldSelection}
                        nbRows={this.state.rows.length}
                        lastRow={lastRow}
                />
              )
            }, this)}
            </form>
            <select onChange={this.handleNumberSelection} defaultValue="10">
              <option value="1">1</option>
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="500">500</option>
            </select>
            <input type="button" value="Generate" onClick={this.handleFormSubmission}/>
            <ResultBox result={this.state.result}/>
          </div>
        )
      }
    });

    ReactDOM.render(
      <FormBox />,
      document.getElementById('content')
    );
    </script>
  </body>
</html>
